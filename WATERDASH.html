<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard KPI - WATERDASH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* VOTRE CSS COMPLET (inchangé) */
        :root {
            --primary: #0c4a6e; --secondary: #075985; --success: #10b981; --warning: #f59e0b;
            --danger: #ef4444; --dark: #0f172a; --darker: #020617; --light: #1e293b; --text: #e2e8f0;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%); color: var(--text); min-height: 100vh; }

        .header { background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 1.8em; margin-bottom: 10px; }
        .header-info { display: flex; gap: 20px; font-size: 0.9em; flex-wrap: wrap; }
        .header-info span { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; }

        .date-selector { background: var(--dark); padding: 15px; border-radius: 12px; margin: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .date-selector h3 { color: #38bdf8; margin-bottom: 15px; }
        .date-controls { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .date-input { padding: 10px; border: 1px solid #334155; border-radius: 8px; background: var(--light); color: var(--text); }
        .date-display { font-size: 1.2em; font-weight: 600; color: var(--success); }

        .btn-group { display: flex; gap: 10px; }
        .btn { background: linear-gradient(90deg, var(--success) 0%, #38bdf8 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4); }
        .btn-secondary { background: linear-gradient(90deg, #0ea5e9 0%, #38bdf8 100%); }
        .btn-danger { background: linear-gradient(90deg, var(--danger) 0%, #f87171 100%); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #fileInput { display: none; }

        .tabs { display: flex; background: var(--light); padding: 0 20px; gap: 5px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .tab-btn { padding: 12px 20px; background: transparent; border: none; color: #94a3b8; cursor: pointer; font-weight: 600; white-space: nowrap; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab-btn.active { color: var(--text); border-bottom-color: #38bdf8; background: rgba(56, 189, 248, 0.1); }

        main { flex: 1; padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .card { background: var(--light); border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); border: 1px solid rgba(56, 189, 248, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(56, 189, 248, 0.3); }
        .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--status-color, #38bdf8); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card-title { font-size: 1.3em; font-weight: 700; color: #38bdf8; display: flex; align-items: center; gap: 10px; }
        .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.8em; font-weight: 700; text-transform: uppercase; }
        .status-conforme { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .status-attention { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }
        .status-critique { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .status-nouveau { background: rgba(56, 189, 248, 0.2); color: #38bdf8; border: 1px solid #38bdf8; }
        .status-info { background: rgba(14, 165, 233, 0.2); color: #0ea5e9; border: 1px solid #0ea5e9; }

        .kpi-card { --status-color: var(--success); position: relative; }
        .kpi-card.attention { --status-color: var(--warning); }
        .kpi-card.critique { --status-color: var(--danger); }
        
        .kpi-gauge { position: relative; width: 120px; height: 60px; margin: 15px auto; }
        .gauge-bg { width: 100%; height: 100%; background: conic-gradient(from 180deg, var(--dark) 0deg, var(--light) 180deg, var(--dark) 360deg); border-radius: 60px 60px 0 0; position: relative; overflow: hidden; }
        .gauge-fill { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: conic-gradient(from 180deg, transparent 0deg, var(--status-color) var(--gauge-angle, 90deg), transparent var(--gauge-angle, 90deg)); border-radius: 60px 60px 0 0; transition: all 1s ease; }
        .gauge-value { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); font-size: 1.8em; font-weight: 700; color: var(--status-color); }
        
        .kpi-value { font-size: 2.2em; font-weight: 700; margin: 15px 0; text-align: center; color: var(--status-color); }
        .kpi-target { font-size: 1em; color: #94a3b8; text-align: center; margin-bottom: 15px; }
        .kpi-details { font-size: 0.9em; color: var(--text); background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-top: 15px; }

        .oee-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .oee-card { background: var(--light); border-radius: 16px; padding: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); text-align: center; }
        .oee-title { font-size: 1.2em; font-weight: 700; color: #38bdf8; margin-bottom: 15px; }
        .oee-value { font-size: 3em; font-weight: 700; margin: 15px 0; color: var(--success); }
        .oee-formula { font-size: 0.9em; color: #94a3b8; margin-bottom: 15px; }
        .oee-components { display: flex; justify-content: space-between; margin-top: 20px; }
        .oee-component { text-align: center; }
        .oee-component-value { font-size: 1.5em; font-weight: 700; }
        .oee-component-label { font-size: 0.8em; color: #94a3b8; }

        .equipment-calendar-container { background: var(--light); border-radius: 16px; padding: 25px; margin-top: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); overflow-x: auto; }
        .equipment-calendar-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .equipment-calendar-table th, .equipment-calendar-table td { padding: 10px; text-align: center; border: 1px solid #334155; min-width: 80px; }
        .equipment-calendar-table th { background: var(--dark); font-weight: 600; color: #38bdf8; position: sticky; top: 0; }
        .equipment-calendar-table .equipment-name { text-align: left; font-weight: 600; min-width: 200px; background: var(--dark); position: sticky; left: 0; }
        .calendar-cell { cursor: pointer; transition: all 0.3s; }
        .calendar-cell:hover { background: rgba(56, 189, 248, 0.1); }
        .status-available { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .status-maintenance { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .status-broken { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .equipment-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .equipment-card { background: var(--light); border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border-left: 4px solid var(--status-color, #38bdf8); }
        .equipment-card.available { --status-color: var(--success); }
        .equipment-card.maintenance { --status-color: var(--warning); }
        .equipment-card.broken { --status-color: var(--danger); }
        
        .equipment-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .equipment-name { font-size: 1.2em; font-weight: 600; color: #38bdf8; }
        .equipment-status { padding: 4px 10px; border-radius: 15px; font-size: 0.75em; font-weight: 700; text-transform: uppercase; }

        .table-container { overflow-x: auto; border-radius: 12px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #334155; }
        th { background: var(--dark); font-weight: 600; color: #38bdf8; position: sticky; top: 0; }
        tr:hover { background: rgba(56, 189, 248, 0.05); }

        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .inventory-item { background: var(--dark); padding: 20px; border-radius: 12px; border-left: 4px solid #38bdf8; transition: all 0.3s; }
        .inventory-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .inventory-item.critical { border-left-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .inventory-item.warning { border-left-color: var(--warning); background: rgba(245, 158, 11, 0.1); }
        .progress-bar { width: 100%; height: 10px; background: var(--dark); border-radius: 5px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--success) 0%, #38bdf8 100%); transition: width 0.8s ease; border-radius: 5px; }

        .filter-controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .filter-controls input, .filter-controls select { padding: 12px 16px; border: 1px solid #334155; border-radius: 8px; background: var(--dark); color: var(--text); font-size: 0.9em; min-width: 200px; }
        .filter-controls button { padding: 12px 20px; border: none; border-radius: 8px; background: linear-gradient(90deg, #0ea5e9 0%, #38bdf8 100%); color: white; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .filter-controls button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(14, 165, 233, 0.4); }

        .alert { padding: 20px; border-radius: 12px; margin-bottom: 25px; display: none; font-weight: 600; border-left: 4px solid; }
        .alert-success { background: rgba(16, 185, 129, 0.1); border-left-color: #10b981; color: #10b981; }
        .alert-error { background: rgba(239, 68, 68, 0.1); border-left-color: #ef4444; color: #ef4444; }
        .alert-info { background: rgba(56, 189, 248, 0.1); border-left-color: #38bdf8; color: #38bdf8; }

        .stats-bar { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
        .stat-item { background: var(--dark); padding: 20px; border-radius: 12px; border-left: 4px solid #38bdf8; min-width: 150px; text-align: center; transition: all 0.3s; }
        .stat-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .stat-value { font-size: 2em; font-weight: 700; color: #38bdf8; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: var(--text-muted); }

        .loading { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--dark); padding: 30px; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.5); border: 1px solid #38bdf8; z-index: 1000; text-align: center; }
        .loading.show { display: block; }
        .spinner { border: 4px solid var(--light); border-top: 4px solid #38bdf8; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tooltip { position: fixed; background: var(--dark); color: var(--text); padding: 10px 15px; border-radius: 8px; font-size: 0.85em; border: 1px solid #38bdf8; pointer-events: none; display: none; z-index: 200; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .btn-group { flex-wrap: wrap; justify-content: center; }
            .tabs { overflow-x: scroll; }
            .kpi-grid { grid-template-columns: 1fr; }
            .stats-bar { justify-content: center; }
            .filter-controls { flex-direction: column; align-items: stretch; }
            .filter-controls input, .filter-controls select { min-width: 100%; }
            .oee-components { flex-direction: column; gap: 10px; }
            .equipment-calendar-table { font-size: 0.7em; }
            .equipment-calendar-table th, .equipment-calendar-table td { padding: 5px; min-width: 60px; }
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        .slide-up { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .popup-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            backdrop-filter: blur(5px);
        }
        .popup-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .popup-content {
            background: var(--light);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--status-color, #38bdf8);
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            animation: popupIn 0.3s ease-out;
        }
        @keyframes popupIn {
            from { transform: scale(0.9) translateY(20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #334155;
        }
        .popup-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--status-color, #38bdf8);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .popup-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .popup-close:hover {
            color: var(--text);
            transform: rotate(90deg);
        }
        .popup-body {
            font-size: 1em;
            line-height: 1.6;
            color: var(--text);
        }
        .popup-body h4 {
            color: #38bdf8;
            margin: 15px 0 10px 0;
            font-size: 1.1em;
        }
        .popup-body ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        .popup-body li {
            margin-bottom: 8px;
            padding-left: 10px;
            position: relative;
        }
        .popup-body li::before {
            content: '•';
            color: var(--status-color, #38bdf8);
            position: absolute;
            left: -15px;
            font-size: 1.2em;
        }
        .popup-footer {
            margin-top: 25px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        .popup-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .popup-btn-primary {
            background: linear-gradient(90deg, var(--success) 0%, #38bdf8 100%);
            color: white;
        }
        .popup-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        .popup-btn-secondary {
            background: var(--dark);
            color: var(--text);
            border: 1px solid #334155;
        }
        .popup-btn-secondary:hover {
            background: var(--primary);
        }

        .alert-icon {
            color: var(--danger);
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s;
            font-size: 1.1em;
        }
        .alert-icon:hover {
            transform: scale(1.2);
            color: #f87171;
        }
        .alert-icon.warning {
            color: var(--warning);
        }
        .alert-icon.warning:hover {
            color: #fbbf24;
        }

        .formation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .formation-card {
            background: var(--dark);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--status-color, #38bdf8);
            transition: all 0.3s;
        }
        .formation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .formation-title {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .formation-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .formation-progress {
            width: 100%;
            height: 6px;
            background: var(--light);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        .formation-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, #38bdf8 100%);
            transition: width 0.8s ease;
        }

        .production-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .production-card {
            background: var(--light);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            border: 1px solid rgba(56, 189, 248, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .production-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(56, 189, 248, 0.3);
        }
        .production-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--status-color, #38bdf8);
        }
        .production-title {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .production-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 5px;
        }
        .production-unit {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-left: 5px;
        }
        .production-trend {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 1em;
            font-weight: 600;
            margin-top: 10px;
            padding: 5px 12px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
        }
        .trend-positive {
            color: var(--success);
        }
        .trend-negative {
            color: var(--danger);
        }
        .production-gauge {
            width: 100%;
            height: 12px;
            background: var(--dark);
            border-radius: 6px;
            overflow: hidden;
            margin-top: 15px;
        }
        .production-gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--status-color) 0%, #38bdf8 100%);
            transition: width 1s ease;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div>
            <h1><i class="fas fa-industry"></i> Dashboard KPI - WATER PLANT by RaFFe</h1>
            <div class="header-info">
                <span><strong><i class="fas fa-calendar-week"></i> Semaine:</strong> <span id="currentWeek">14 avril 2025</span></span>
                <span><strong><i class="fas fa-shield-alt"></i> Statut:</strong> <span class="status-badge status-conforme">Opérationnel</span></span>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn" onclick="downloadExcel()"><i class="fas fa-download"></i> Télécharger Excel</button>
            <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Importer Excel</button>
            <button class="btn btn-danger" onclick="resetAllData()"><i class="fas fa-redo"></i> Reset Données</button>
            <button class="btn" onclick="downloadTemplate()"><i class="fas fa-file-excel"></i> Télécharger Template</button>
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
        </div>
    </div>

    <!-- DATE SELECTOR -->
    <div class="date-selector">
        <h3><i class="fas fa-calendar-alt"></i> Sélection de la période</h3>
        <div class="date-controls">
            <label for="startDate">Date de début:</label>
            <input type="date" id="startDate" class="date-input" value="2025-04-14">
            <label for="endDate">Date de fin:</label>
            <input type="date" id="endDate" class="date-input" value="2025-04-18">
            <button class="btn" onclick="updateDateRange()">Mettre à jour</button>
            <div class="date-display" id="dateRangeDisplay">14 - 18 avril 2025</div>
        </div>
    </div>

    <!-- ALERTES -->
    <div class="alert alert-info" id="alertInfo"><i class="fas fa-info-circle"></i> Info: Prêt à importer</div>
    <div class="alert alert-success" id="alertSuccess"><i class="fas fa-check-circle"></i> Succès !</div>
    <div class="alert alert-error" id="alertError"><i class="fas fa-exclamation-circle"></i> Erreur !</div>

    <!-- STATS BAR -->
    <div class="stats-bar">
        <div class="stat-item slide-up">
            <div class="stat-value" id="statKPI">0</div>
            <div class="stat-label">KPI Actifs</div>
        </div>
        <div class="stat-item slide-up">
            <div class="stat-value" id="statSafety">0</div>
            <div class="stat-label">Événements SST</div>
        </div>
        <div class="stat-item slide-up">
            <div class="stat-value" id="statMaintenance">0</div>
            <div class="stat-label">Tâches Maintenance</div>
        </div>
        <div class="stat-item slide-up">
            <div class="stat-value" id="statInventory">0</div>
            <div class="stat-label">Produits Chimiques</div>
        </div>
    </div>

    <!-- LOADING -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div style="text-align: center; font-weight: 600;">Importation en cours...</div>
    </div>

    <!-- POP-UP MODAL -->
    <div class="popup-modal" id="popupModal">
        <div class="popup-content">
            <div class="popup-header">
                <div class="popup-title" id="popupTitle"><i class="fas fa-exclamation-triangle"></i> Alert</div>
                <button class="popup-close" onclick="closePopup()"><i class="fas fa-times"></i></button>
            </div>
            <div class="popup-body" id="popupBody">
                <!-- Content dynamically filled -->
            </div>
            <div class="popup-footer">
                <button class="popup-btn popup-btn-secondary" onclick="closePopup()">Fermer</button>
                <button class="popup-btn popup-btn-primary" id="popupActionBtn" onclick="popupAction()">Prendre action</button>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <nav class="tabs">
        <button class="tab-btn active" onclick="showTab('kpi', event)"><i class="fas fa-chart-line"></i> KPI Principaux</button>
        <button class="tab-btn" onclick="showTab('suivi', event)"><i class="fas fa-flask"></i> Suivi Procédé</button>
        <button class="tab-btn" onclick="showTab('inventaire', event)"><i class="fas fa-boxes"></i> Inventaire</button>
        <button class="tab-btn" onclick="showTab('securite', event)"><i class="fas fa-hard-hat"></i> Sécurité</button>
        <button class="tab-btn" onclick="showTab('maintenance', event)"><i class="fas fa-tools"></i> Maintenance</button>
        <button class="tab-btn" onclick="showTab('planning', event)"><i class="fas fa-calendar-alt"></i> Planning</button>
        <button class="tab-btn" onclick="showTab('equipements', event)"><i class="fas fa-cogs"></i> Équipements</button>
        <button class="tab-btn" onclick="showTab('performances', event)"><i class="fas fa-tachometer-alt"></i> Performances OEE</button>
    </nav>

    <main>
        <!-- KPI -->
        <div id="kpi" class="tab-content active">
            <!-- NOUVEAU : Section Production Overview -->
            <div class="production-overview" id="productionOverview"></div>
            
            <!-- KPI Grid existant -->
            <div class="kpi-grid" id="kpiGrid"></div>
            
            <!-- Objectifs Hebdo -->
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-bullseye"></i> Objectifs Hebdomadaires</h3>
                </div>
                <div class="table-container">
                    <table id="objectivesTable"></table>
                </div>
            </div>
        </div>

        <!-- SUIVI PROCEDE -->
        <div id="suivi" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-flask"></i> Paramètres de Contrôle</h3>
                </div>
                <div class="filter-controls">
                    <input type="text" id="paramFilter" placeholder="Filtrer paramètre...">
                    <button onclick="filterTable()"><i class="fas fa-search"></i> Filtrer</button>
                    <button onclick="resetFilter()"><i class="fas fa-undo"></i> Réinitialiser</button>
                </div>
                <div class="table-container">
                    <table id="paramTable"></table>
                </div>
            </div>
        </div>

        <!-- INVENTAIRE -->
        <div id="inventaire" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-boxes"></i> Stock Produits Chimiques</h3>
                </div>
                <div class="inventory-grid" id="inventoryGrid"></div>
            </div>
        </div>

        <!-- SECURITE -->
        <div id="securite" class="tab-content">
            <div class="formation-grid" id="formationGrid"></div>
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-hard-hat"></i> Indicateurs SST 2025</h3>
                </div>
                <div class="table-container">
                    <table id="safetyTable"></table>
                </div>
            </div>
        </div>

        <!-- MAINTENANCE -->
        <div id="maintenance" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tools"></i> Maintenance Planifiée</h3>
                </div>
                <div class="table-container">
                    <table id="maintenanceTable"></table>
                </div>
            </div>
        </div>

        <!-- PLANNING -->
        <div id="planning" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Planning Hebdomadaire</h3>
                </div>
                <div class="table-container">
                    <table id="planningTable"></table>
                </div>
            </div>
        </div>

        <!-- EQUIPEMENTS -->
        <div id="equipements" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-cogs"></i> Équipements par Secteur</h3>
                </div>
                <div class="equipment-list" id="equipmentList"></div>
            </div>
            
            <div class="equipment-calendar-container fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-calendar-check"></i> Calendrier des Équipements</h3>
                </div>
                <table class="equipment-calendar-table" id="equipmentCalendarTable"></table>
            </div>
            
            <div class="card fade-in" style="margin-top: 20px;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-history"></i> Suivi Long Terme</h3>
                </div>
                <div class="filter-controls">
                    <input type="text" id="equipementFilter" placeholder="Filtrer équipement...">
                    <button onclick="filterEquipement()"><i class="fas fa-search"></i> Filtrer</button>
                </div>
                <div class="table-container">
                    <table id="suiviTable"></table>
                </div>
            </div>
        </div>

        <!-- PERFORMANCES OEE -->
        <div id="performances" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-tachometer-alt"></i> Performance OEE - Usine Des Baillets</h3>
                </div>
                <div class="oee-container" id="oeeContainer"></div>
                <div class="table-container" style="margin-top: 25px;">
                    <table id="performanceTable"></table>
                </div>
            </div>
        </div>
    </main>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // STRUCTURE DES DONNÉES
        let dashboardData = {
            kpi: [], securiteFormations: [], suivi: [], inventaire: [], securite: [], maintenance: [], 
            planning: [], equipements: [], suiviLongTerme: [], legionelle: [], objectives: [],
            equipmentAvailability: [], oeeData: [], productionKPI: []
        };

        let currentDateRange = {
            start: new Date(2025, 3, 14),
            end: new Date(2025, 3, 18)
        };

        // DONNÉES PAR DÉFAUT
        function initializeData() {
            // KPI Principaux
            dashboardData.kpi = [
                { domaine: "QUALITE", indicateur: "Turbidité Filtration", valeur: "<0.3 uTN", cible: "<0.3 uTN", statut: "conforme", responsable: "Opérateur", frequence: "Continue", pourcentage: 98 },
                { domaine: "QUALITE", indicateur: "Chlore Résiduel", valeur: "0,2-2,0 mg/l", cible: "0,2-2,0 mg/l", statut: "conforme", responsable: "Analyseur auto", frequence: "Continue", pourcentage: 96 },
                { domaine: "QUALITE", indicateur: "Coagulant", valeur: "Optimisé", cible: "<seuil critique", statut: "attention", responsable: "Technicien", frequence: "Horaire", pourcentage: 78 },
                { domaine: "SECURITE", indicateur: "Accidents/Incidents", valeur: "0", cible: "0", statut: "conforme", responsable: "Superviseur SSME", frequence: "Quotidien", pourcentage: 100 },
                { domaine: "SECURITE", indicateur: "Passés-proche", valeur: "<2/mois", cible: "<2/mois", statut: "conforme", responsable: "Equipe sécurité", frequence: "Hebdomadaire", pourcentage: 92 },
                { domaine: "MAINTENANCE", indicateur: "Maintenance Préventive", valeur: "100%", cible: "100%", statut: "conforme", responsable: "Technicien", frequence: "Quotidien", pourcentage: 100 },
                { domaine: "MAINTENANCE", indicateur: "Disponibilité Équipements", valeur: ">95%", cible: ">95%", statut: "conforme", responsable: "Technicien", frequence: "Quotidien", pourcentage: 97 }
            ];

            // KPI Production
            dashboardData.productionKPI = [
                { 
                    indicateur: "Débit eau distribué", 
                    valeur: 184500, 
                    cible: 180000, 
                    unite: "m³/jour", 
                    statut: "conforme", 
                    variation: 2.5, 
                    icone: "fa-tint", 
                    pourcentage: 102.5,
                    min: 150000,
                    max: 200000
                },
                { 
                    indicateur: "Niveau réservoir principal", 
                    valeur: 78, 
                    cible: 75, 
                    unite: "%", 
                    statut: "conforme", 
                    variation: -3.2, 
                    icone: "fa-database", 
                    pourcentage: 78,
                    min: 60,
                    max: 90
                },
                { 
                    indicateur: "Taux de remplissage", 
                    valeur: 2.1, 
                    cible: 0, 
                    unite: "%/h", 
                    statut: "positif", 
                    variation: 0.8, 
                    icone: "fa-arrow-trend-up", 
                    pourcentage: 100,
                    min: -5,
                    max: 5
                }
            ];

            // Reste des données
            dashboardData.securiteFormations = [
                { module: "Habilitation électrique", planifiees: 3, realisees: 2, prochaine: "2025-04-20", responsable: "SSME", statut: "en_cours", pourcentage: 67 },
                { module: "Travail en hauteur", planifiees: 5, realisees: 5, prochaine: "2025-04-25", responsable: "SSME", statut: "conforme", pourcentage: 100 },
                { module: "Premiers secours", planifiees: 8, realisees: 3, prochaine: "2025-04-22", responsable: "Infirmier", statut: "attention", pourcentage: 38 },
                { module: "Signalisation routière", planifiees: 2, realisees: 2, prochaine: "2025-05-01", responsable: "SSME", statut: "conforme", pourcentage: 100 },
                { module: "Gestion des produits chimiques", planifiees: 6, realisees: 1, prochaine: "2025-04-18", responsable: "Superviseur", statut: "critique", pourcentage: 17 }
            ];

            dashboardData.suivi = [
                { param: "Débit Usine brute (m³/s)", lundi: "8", mardi: "8.1", mercredi: "8.2", jeudi: "8.2", vendredi: "8.4", commentaire: "Selon demande" },
                { param: "Coagulant (mg/l)", lundi: "33", mardi: "33", mercredi: "35", jeudi: "32", vendredi: "31", commentaire: "Optimisé" },
                { param: "Turbidité Eau Brute (uTN)", lundi: "2", mardi: "2", mercredi: "3", jeudi: "2", vendredi: "2", commentaire: "En seuil" },
                { param: "Turbidité Filtration (uTN)", lundi: "0.11", mardi: "0.11", mercredi: "0.11", jeudi: "0.11", vendredi: "0.11", commentaire: "<0.2 uTN" },
                { param: "Perte de Charge (m)", lundi: "1", mardi: "1", mercredi: "1", jeudi: "1", vendredi: "1", commentaire: "Surveillée" },
                { param: "[OCl-] (mg/l)", lundi: "1", mardi: "1", mercredi: "1.1", jeudi: "0.9", vendredi: "1", commentaire: "0,2-2,0 mg/l" }
            ];

            dashboardData.inventaire = [
                { produit: "Coag (L)", actuel: 23456, seuil: 5000, critique: 2000, prochaine: "8900", commande: "45758", statut: "conforme" },
                { produit: "Aide-Coag (L)", actuel: 7655, seuil: 2000, critique: 2000, prochaine: "?", commande: "45755", statut: "conforme" },
                { produit: "ThioSulphate (L)", actuel: 10500, seuil: 500, critique: 2000, prochaine: "?", commande: "45756", statut: "conforme" },
                { produit: "Sel (m)", actuel: 0.46, seuil: 0.5, critique: 0.5, prochaine: "2.14", commande: "45757", statut: "attention" },
                { produit: "Diesel (L) x2", actuel: 499, seuil: 500, critique: 500, prochaine: "?", commande: "?", statut: "conforme" },
                { produit: "Hypochlorite Sodium 12% (L)", actuel: 5, seuil: 10000, critique: 3000, prochaine: "10 000 L", commande: "Jeudi 10 avril", statut: "critique" }
            ];

            dashboardData.securite = [
                { indicateur: "Nombre total d'événements", objectif: 0, actuel: 0, ecart: 0, statut: "conforme", action: "Maintenir vigilance" },
                { indicateur: "Nombre d'accidents et incidents", objectif: 0, actuel: 2, ecart: 2, statut: "attention", action: "Investigation en cours" },
                { indicateur: "Nombre passés-proche", objectif: 2, actuel: 1, ecart: -1, statut: "conforme", action: "Sensibilisation continue" },
                { indicateur: "Formations SST en retard", objectif: 0, actuel: 2, ecart: 2, statut: "critique", action: "Planifier sessions urgences" }
            ];

            dashboardData.maintenance = [
                { equipement: "Analyseur chlore #1", planifie: "Lundi 7", duree: "2h", type: "Étalonnage", responsable: "Technicien", statut: "conforme" },
                { equipement: "Analyseur #2", planifie: "Mardi 8-9", duree: "2 jours", type: "Contrôle boucle", responsable: "Technicien", statut: "conforme" },
                { equipement: "UV #6", planifie: "Dimanche soir", duree: "4h", type: "Maintenance", responsable: "Technicien", statut: "conforme" },
                { equipement: "Débitmètre 702220", planifie: "Mardi 8", duree: "30 min", type: "Entretien", responsable: "Equipe projet", statut: "conforme" },
                { equipement: "Générateurs Hypo #1-2", planifie: "Jeudi 10", duree: "7h", type: "Isolation", responsable: "Maintenance", statut: "conforme" },
                { equipement: "Nourrices", planifie: "Mardi 8", duree: "1h", type: "Entretien débitmètres", responsable: "Maintenance", statut: "conforme" }
            ];

            dashboardData.planning = [
                { jour: "LUNDI 14", heure: "14:00", activite: "Rencontre CLSST - UXX_UYY", type: "INFO", duree: "2h", responsable: "SSME", statut: "nouveau" },
                { jour: "LUNDI 14", heure: "14:00", activite: "Arrêt d'usine DI-708730", type: "ELEC", duree: "2h", responsable: "Électricien", statut: "nouveau" },
                { jour: "MARDI 15", heure: "08:00", activite: "MP Sondes UV", type: "INST", duree: "2 jours", responsable: "Technicien", statut: "nouveau" },
                { jour: "MERCREDI 16", heure: "14:00", activite: "Décadenassage DI-708730", type: "ELEC", duree: "2h", responsable: "Électricien", statut: "nouveau" },
                { jour: "JEUDI 17", heure: "08:00", activite: "Férie Lundi 21 avril", type: "INFO", duree: "4 jours", responsable: "Tous", statut: "nouveau" }
            ];

            dashboardData.equipements = [
                { secteur: "GÉNÉRAL", code: "0-0", equipements_principaux: "Groupe électrogène, Réservoir diesel No. 1-3, Système d'alimentation sans coupure", plc: "", statut: "available", disponibilite: 98 },
                { secteur: "TRAITEMENT BOUES", code: "0-5", equipements_principaux: "Système ventilation #1, Système chauffage général, Alarme-incendie", plc: "", statut: "available", disponibilite: 95 },
                { secteur: "PRISE D'EAU", code: "1-0", equipements_principaux: "Dégrilleurs manuels, Tamis rotatifs, Chambre vannes No.7", plc: "PLC-1", statut: "available", disponibilite: 99 },
                { secteur: "POMPAGE BP", code: "2-0", equipements_principaux: "15 GMP BP-1 à BP-15, Bassins, Analyseurs", plc: "PLC-2", statut: "maintenance", disponibilite: 85 },
                { secteur: "COAGULATION/DÉCANTATION", code: "3-0", equipements_principaux: "4 Nourrices (NE/NO/SE/SO), Pompes doseuses", plc: "PLC-3", statut: "available", disponibilite: 97 },
                { secteur: "FILTRATION", code: "4-0", equipements_principaux: "60 Filtres Des Baillets, Lavage air/eau", plc: "PLC-4", statut: "available", disponibilite: 96 },
                { secteur: "CHLORATION", code: "5-0", equipements_principaux: "Production eau chaude, Détecteurs de gaz", plc: "", statut: "available", disponibilite: 94 },
                { secteur: "OZONATION", code: "6-0", equipements_principaux: "4 Cuves ozonation, 2 Ozoneurs, Injection", plc: "PLC-6", statut: "broken", disponibilite: 0 },
                { secteur: "HAUTE PRESSION", code: "7-0", equipements_principaux: "GMP HP, Distribution, Colonnes compensation", plc: "PLC-7", statut: "available", disponibilite: 98 },
                { secteur: "DÉSINFECTION UV", code: "8-0", equipements_principaux: "14 Réacteurs UV, 6 salles cuves", plc: "PLC-8", statut: "available", disponibilite: 93 }
            ];

            dashboardData.suiviLongTerme = [
                { référence: "1066358", type: "PHC", domaine: "Oper", description: "Situation A", statut: "EN COURS", ref: "-", alert: "", detail: "Pompe principale fonctionne à 85% de sa capacité. Surveillance continue requise." },
                { référence: "1065741", type: "PLAN", domaine: "Oper", description: "Situation B", statut: "À SUIVRE", ref: "44922", alert: "critical", detail: "Vanne #2 ne répond plus aux commandes automatiques. Mode manuel activé." },
                { référence: "1064567", type: "PLAN", domaine: "Oper", description: "Situation C", statut: "EN COURS", ref: "-", alert: "warning", detail: "Alarme intermittente depuis 3 jours. Diagnostic en cours." },
                { référence: "1064947", type: "PLAN", domaine: "Oper", description: "Situation A", statut: "EN COURS", ref: "-", alert: "", detail: "Alarme niveau bas. Vérification des sondes en cours." },
                { référence: "", type: "PLAN", domaine: "Oper", description: "Situation B", statut: "À SUIVRE", ref: "44831", alert: "critical", detail: "Panne de communication depuis 48h. Accès sur site nécessaire." },
                { référence: "", type: "AUTO", domaine: "Oper", description: "Situation C", statut: "POUR INFO", ref: "", alert: "warning", detail: "12 alarmes sur 45 ne sont pas configurées dans le SCADA." },
                { référence: "1056217", type: "PLAN", domaine: "Oper", description: "Situation A", statut: "EN COURS", ref: "44806", alert: "", detail: "Tests hebdomadaires en cours. Tous les détecteurs fonctionnels." },
                { référence: "1047807", type: "PLAN", domaine: "Oper", description: "Situation B", statut: "À SUIVRE", ref: "44806", alert: "critical", detail: "Système d'incendie hors service. Intervention d'urgence requise." },
                { référence: "1066355", type: "PHC", domaine: "Oper", description: "Situation C", statut: "À SUIVRE", ref: "44938", alert: "warning", detail: "Déflecteur nécessite réparation mécanique. Température impactée." }
            ];

            dashboardData.objectives = [
                { domaine: "PRODUCTION", objectif: "Maintenir débit optimal", mesure: "Selon demande", echeance: "Vendredi 18", responsable: "Superviseur", statut: "conforme" },
                { domaine: "QUALITE", objectif: "Turbidité <0,3 uTN", mesure: "Continue", echeance: "Quotidien", responsable: "Opérateur", statut: "conforme" },
                { domaine: "SECURITE", objectif: "Zero accident", mesure: "0 événement", echeance: "Vendredi 18", responsable: "SSME", statut: "conforme" },
                { domaine: "RH", objectif: "100% formations obligatoires", mesure: "3 modules", echeance: "Vendredi 18", responsable: "SSME", statut: "attention" }
            ];

            dashboardData.equipmentAvailability = [
                { date: "2025-04-14", equipment: "POMPAGE BP", status: "maintenance", description: "Maintenance préventive" },
                { date: "2025-04-15", equipment: "OZONATION", status: "broken", description: "Réparation ozoneur" },
                { date: "2025-04-16", equipment: "POMPAGE BP", status: "available", description: "Opérationnel" },
                { date: "2025-04-17", equipment: "FILTRATION", status: "maintenance", description: "Nettoyage filtres" },
                { date: "2025-04-18", equipment: "OZONATION", status: "available", description: "Réparation terminée" },
                { date: "2025-04-20", equipment: "CHLORATION", status: "maintenance", description: "Étalonnage détecteurs" },
                { date: "2025-04-22", equipment: "UV", status: "broken", description: "Remplacement lampe" }
            ];

            dashboardData.oeeData = [
                { 
                    equipement: "FILTRATION", 
                    disponibilite: 96.2, 
                    performance: 94.8, 
                    qualite: 98.5, 
                    oee: 89.7,
                    temps_planifie: 168,
                    temps_arret: 6.4,
                    temps_reel: 161.6,
                    production_theorique: 2400,
                    production_reelle: 2278
                },
                { 
                    equipement: "POMPAGE BP", 
                    disponibilite: 85.0, 
                    performance: 92.3, 
                    qualite: 97.8, 
                    oee: 76.8,
                    temps_planifie: 168,
                    temps_arret: 25.2,
                    temps_reel: 142.8,
                    production_theorique: 1800,
                    production_reelle: 1317
                },
                { 
                    equipement: "OZONATION", 
                    disponibilite: 0.0, 
                    performance: 0.0, 
                    qualite: 0.0, 
                    oee: 0.0,
                    temps_planifie: 168,
                    temps_arret: 168,
                    temps_reel: 0,
                    production_theorique: 1200,
                    production_reelle: 0
                },
                { 
                    equipement: "CHLORATION", 
                    disponibilite: 94.0, 
                    performance: 91.5, 
                    qualite: 99.2, 
                    oee: 85.3,
                    temps_planifie: 168,
                    temps_arret: 10.1,
                    temps_reel: 157.9,
                    production_theorique: 1500,
                    production_reelle: 1445
                },
                { 
                    equipement: "DÉSINFECTION UV", 
                    disponibilite: 93.0, 
                    performance: 89.7, 
                    qualite: 96.8, 
                    oee: 80.6,
                    temps_planifie: 168,
                    temps_arret: 11.8,
                    temps_reel: 156.2,
                    production_theorique: 1000,
                    production_reelle: 890
                }
            ];
        }

        // FONCTION DE NETTOYAGE EXCEL (CORRIGÉE ET COMPLÉTÉE)
        function cleanExcelData(ws) {
            if (!ws) return [];
            
            const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
            if (rawData.length < 2) return [];
            
            // Détection intelligente du header
            const firstRow = rawData.find(row => row.some(cell => cell && String(cell).trim()));
            if (!firstRow) return [];
            
            const headerRowIndex = rawData.indexOf(firstRow);
            const headers = firstRow.map(h => {
                if (!h && typeof h !== 'number') return null;
                const header = String(h).trim();
                // Mapping des noms de colonnes français vers clés standardisées
                const mappings = {
                    'indicateur': ['indicateur', 'paramètre', 'parametre', 'domaine', 'domain'],
                    'valeur': ['valeur', 'value', 'actuel', 'actual'],
                    'cible': ['cible', 'target', 'objectif'],
                    'statut': ['statut', 'status', 'état'],
                    'responsable': ['responsable', 'owner'],
                    'frequence': ['frequence', 'frequency', 'fréquence'],
                    'pourcentage': ['pourcentage', 'percentage', '%']
                };
                
                for (const [key, variants] of Object.entries(mappings)) {
                    if (variants.some(v => header.toLowerCase().includes(v))) {
                        return key;
                    }
                }
                return header.toLowerCase().replace(/\s+/g, '_');
            }).filter(Boolean);
            
            const dataRows = rawData.slice(headerRowIndex + 1).filter(row => 
                row.some(cell => cell !== null && cell !== undefined && cell !== '')
            );
            
            return dataRows.map(row => {
                const obj = {};
                headers.forEach((header, idx) => {
                    if (!header) return;
                    let value = row[idx];
                    
                    // Nettoyage des valeurs
                    if (typeof value === 'string') {
                        value = value.trim();
                        // Conversion des nombres français
                        if (/^-?\d+[\.,]\d+$/.test(value)) {
                            value = parseFloat(value.replace('.', '').replace(',', '.'));
                        }
                        // Suppression des espaces dans les nombres
                        else if (/^-?\d+(\s\d+)*$/.test(value)) {
                            value = parseInt(value.replace(/\s/g, ''));
                        }
                    }
                    
                    // Normalisation des statuts
                    if (header === 'statut' && typeof value === 'string') {
                        value = value.toLowerCase();
                        if (['conforme', 'ok', 'good', 'valide'].some(v => value.includes(v))) {
                            obj[header] = 'conforme';
                        } else if (['attention', 'warning', 'alerte'].some(v => value.includes(v))) {
                            obj[header] = 'attention';
                        } else if (['critique', 'danger', 'error', 'erreur'].some(v => value.includes(v))) {
                            obj[header] = 'critique';
                        } else {
                            obj[header] = value;
                        }
                        return;
                    }
                    
                    obj[header] = value;
                });
                return obj;
            });
        }

        // GESTION DES TABS
        function showTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            if (event) event.target.classList.add('active');
            
            // Charger les données du tab si nécessaire
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            switch(tabName) {
                case 'kpi':
                    renderKPI();
                    renderProductionOverview();
                    renderObjectives();
                    break;
                case 'suivi':
                    renderSuiviTable();
                    break;
                case 'inventaire':
                    renderInventory();
                    break;
                case 'securite':
                    renderFormationGrid();
                    renderSafetyTable();
                    break;
                case 'maintenance':
                    renderMaintenanceTable();
                    break;
                case 'planning':
                    renderPlanningTable();
                    break;
                case 'equipements':
                    renderEquipmentList();
                    renderEquipmentCalendar();
                    renderSuiviLongTerme();
                    break;
                case 'performances':
                    renderOEE();
                    renderPerformanceTable();
                    break;
            }
            updateStats();
        }

        // RENDU DES SECTIONS
        function renderProductionOverview() {
            const container = document.getElementById('productionOverview');
            container.innerHTML = '';
            
            dashboardData.productionKPI.forEach(item => {
                const card = document.createElement('div');
                card.className = 'production-card fade-in';
                card.style.setProperty('--status-color', getStatusColor(item.statut));
                
                const percentage = ((item.valeur - item.min) / (item.max - item.min)) * 100;
                const trendClass = item.variation > 0 ? 'trend-positive' : 'trend-negative';
                const trendIcon = item.variation > 0 ? 'fa-arrow-up' : 'fa-arrow-down';
                
                card.innerHTML = `
                    <div class="production-title">${item.indicateur}</div>
                    <div class="production-value">
                        ${formatNumber(item.valeur)} 
                        <span class="production-unit">${item.unite}</span>
                    </div>
                    <div class="production-trend ${trendClass}">
                        <i class="fas ${trendIcon}"></i> ${Math.abs(item.variation)}%
                    </div>
                    <div class="production-gauge">
                        <div class="production-gauge-fill" style="width: ${Math.max(0, Math.min(100, percentage))}%"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: var(--text-muted);">
                        Cible: ${formatNumber(item.cible)} ${item.unite}
                        <i class="fas fa-info-circle alert-icon ${item.statut === 'attention' ? 'warning' : ''}" 
                           onclick="showPopup('${item.indicateur}', '${item.detail || 'Pas de détails supplémentaires'}', '${item.statut}')"></i>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function renderKPI() {
            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = '';
            
            dashboardData.kpi.forEach(item => {
                const card = document.createElement('div');
                card.className = `kpi-card ${item.statut} fade-in`;
                card.style.setProperty('--status-color', getStatusColor(item.statut));
                card.style.setProperty('--gauge-angle', `${(item.pourcentage / 100) * 180}deg`);
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">${item.indicateur}</div>
                        <span class="status-badge status-${item.statut}">${item.statut.toUpperCase()}</span>
                    </div>
                    <div class="kpi-gauge">
                        <div class="gauge-bg"></div>
                        <div class="gauge-fill"></div>
                        <div class="gauge-value">${item.pourcentage}%</div>
                    </div>
                    <div class="kpi-value">${item.valeur}</div>
                    <div class="kpi-target">Cible: ${item.cible}</div>
                    <div class="kpi-details">
                        <strong>Responsable:</strong> ${item.responsable}<br>
                        <strong>Fréquence:</strong> ${item.frequence}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function renderObjectives() {
            const table = document.getElementById('objectivesTable');
            const headers = ['Domaine', 'Objectif', 'Mesure', 'Échéance', 'Responsable', 'Statut'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.objectives.map(obj => `
                    <tr>
                        <td>${obj.domaine}</td>
                        <td>${obj.objectif}</td>
                        <td>${obj.mesure}</td>
                        <td>${obj.echeance}</td>
                        <td>${obj.responsable}</td>
                        <td><span class="status-badge status-${obj.statut}">${obj.statut.toUpperCase()}</span></td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderSuiviTable() {
            const table = document.getElementById('paramTable');
            if (!table || !dashboardData.suivi.length) return;
            
            const headers = ['Paramètre', ...Object.keys(dashboardData.suivi[0]).filter(k => k !== 'param' && k !== 'commentaire'), 'Commentaire'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h.charAt(0).toUpperCase() + h.slice(1)}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.suivi.map(row => `
                    <tr>
                        <td style="font-weight: 600; color: #38bdf8;">${row.param}</td>
                        ${headers.slice(1, -1).map(h => `<td>${row[h.toLowerCase()] || '-'}</td>`).join('')}
                        <td style="font-style: italic; color: var(--text-muted);">${row.commentaire}</td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = '';
            
            dashboardData.inventaire.forEach(item => {
                const stockPercentage = (item.actuel / item.seuil) * 100;
                const card = document.createElement('div');
                card.className = `inventory-item ${item.statut} fade-in`;
                card.innerHTML = `
                    <h4>${item.produit}</h4>
                    <div style="font-size: 1.5em; font-weight: 700; margin: 10px 0;">
                        ${formatNumber(item.actuel)} <span style="font-size: 0.6em; color: var(--text-muted);">/ ${formatNumber(item.seuil)}</span>
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">
                        Commande: ${item.commande || 'N/A'}<br>
                        Prochaine livraison: ${item.prochaine || 'Inconnue'}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${Math.min(100, stockPercentage)}%"></div>
                    </div>
                    <span class="status-badge status-${item.statut}" style="margin-top: 10px; display: inline-block;">
                        ${item.statut.toUpperCase()}
                    </span>
                `;
                grid.appendChild(card);
            });
        }

        function renderFormationGrid() {
            const grid = document.getElementById('formationGrid');
            grid.innerHTML = '';
            
            dashboardData.securiteFormations.forEach(formation => {
                const card = document.createElement('div');
                card.className = 'formation-card fade-in';
                card.style.setProperty('--status-color', getStatusColor(formation.statut));
                
                card.innerHTML = `
                    <div class="formation-title">${formation.module}</div>
                    <div class="formation-value" style="color: var(--status-color);">${formation.pourcentage}%</div>
                    <div style="font-size: 0.9em; color: var(--text-muted);">
                        ${formation.realisees} / ${formation.planifiees} réalisées
                    </div>
                    <div class="formation-progress">
                        <div class="formation-progress-fill" style="width: ${formation.pourcentage}%"></div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8em;">
                        Prochaine: ${formatDate(formation.prochaine)}<br>
                        Resp: ${formation.responsable}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderSafetyTable() {
            const table = document.getElementById('safetyTable');
            const headers = ['Indicateur', 'Objectif', 'Actuel', 'Écart', 'Statut', 'Action'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.securite.map(item => `
                    <tr>
                        <td>${item.indicateur}</td>
                        <td>${item.objectif}</td>
                        <td>${item.actuel}</td>
                        <td style="color: ${item.ecart > 0 ? 'var(--danger)' : 'var(--success)'}">${item.ecart > 0 ? '+' : ''}${item.ecart}</td>
                        <td><span class="status-badge status-${item.statut}">${item.statut.toUpperCase()}</span></td>
                        <td>${item.action} <i class="fas fa-info-circle alert-icon" onclick="showPopup('${item.indicateur}', '${item.action}', '${item.statut}')"></i></td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderMaintenanceTable() {
            const table = document.getElementById('maintenanceTable');
            const headers = ['Équipement', 'Planifié', 'Durée', 'Type', 'Responsable', 'Statut'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.maintenance.map(item => `
                    <tr>
                        <td style="font-weight: 600;">${item.equipement}</td>
                        <td>${item.planifie}</td>
                        <td>${item.duree}</td>
                        <td><span class="status-badge status-info">${item.type}</span></td>
                        <td>${item.responsable}</td>
                        <td><span class="status-badge status-${item.statut}">${item.statut.toUpperCase()}</span></td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderPlanningTable() {
            const table = document.getElementById('planningTable');
            const headers = ['Jour', 'Heure', 'Activité', 'Type', 'Durée', 'Responsable', 'Statut'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.planning.map(item => `
                    <tr style="${item.statut === 'nouveau' ? 'animation: pulse 2s infinite;' : ''}">
                        <td style="font-weight: 600; color: #38bdf8;">${item.jour}</td>
                        <td>${item.heure}</td>
                        <td>${item.activite}</td>
                        <td><span class="status-badge status-info">${item.type}</span></td>
                        <td>${item.duree}</td>
                        <td>${item.responsable}</td>
                        <td><span class="status-badge status-${item.statut}">${item.statut.toUpperCase()}</span></td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderEquipmentList() {
            const grid = document.getElementById('equipmentList');
            grid.innerHTML = '';
            
            dashboardData.equipements.forEach(item => {
                const card = document.createElement('div');
                card.className = `equipment-card ${item.statut} fade-in`;
                card.innerHTML = `
                    <div class="equipment-header">
                        <div class="equipment-name">${item.secteur}</div>
                        <span class="status-badge status-${item.statut}">${item.disponibilite}%</span>
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-muted); margin-bottom: 10px;">
                        Code: ${item.code}<br>
                        PLC: ${item.plc || 'N/A'}
                    </div>
                    <div style="font-size: 0.85em; line-height: 1.4;">
                        ${item.equipements_principaux}
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function renderEquipmentCalendar() {
            const table = document.getElementById('equipmentCalendarTable');
            const dates = [...new Set(dashboardData.equipmentAvailability.map(item => item.date))].sort();
            const equipment = [...new Set(dashboardData.equipmentAvailability.map(item => item.equipment))];
            
            let html = '<thead><tr><th class="equipment-name">Équipement</th>';
            dates.forEach(date => {
                html += `<th>${formatDateShort(date)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            equipment.forEach(eq => {
                html += `<tr><td class="equipment-name">${eq}</td>`;
                dates.forEach(date => {
                    const status = dashboardData.equipmentAvailability.find(
                        item => item.equipment === eq && item.date === date
                    );
                    html += `<td class="calendar-cell status-${status ? status.status : 'available'}" 
                                 title="${status ? status.description : 'Opérationnel'}"
                                 onclick="showPopup('${eq} - ${formatDateShort(date)}', '${status ? status.description : 'Équipement opérationnel'}', '${status ? status.status : 'available'}')">
                                 ${status ? status.status.charAt(0).toUpperCase() : 'O'}
                             </td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody>';
            table.innerHTML = html;
        }

        function renderSuiviLongTerme() {
            const table = document.getElementById('suiviTable');
            const headers = ['Référence', 'Type', 'Domaine', 'Description', 'Statut', 'Réf', 'Alerte', 'Actions'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.suiviLongTerme.map(item => `
                    <tr>
                        <td>${item.référence || '-'}</td>
                        <td><span class="status-badge status-info">${item.type}</span></td>
                        <td>${item.domaine}</td>
                        <td>${item.description}</td>
                        <td><span class="status-badge status-${getStatusFromText(item.statut)}">${item.statut}</span></td>
                        <td>${item.ref || '-'}</td>
                        <td>${item.alert ? `<i class="fas fa-exclamation-triangle alert-icon ${item.alert}"></i>` : '-'}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 0.8em;" 
                                    onclick="showPopup('${item.description}', '${item.detail || 'Pas de détails'}', '${item.alert || 'info'}')">
                                <i class="fas fa-eye"></i> Détail
                            </button>
                        </td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        function renderOEE() {
            const container = document.getElementById('oeeContainer');
            container.innerHTML = '';
            
            dashboardData.oeeData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'oee-card fade-in';
                card.innerHTML = `
                    <div class="oee-title">${item.equipement}</div>
                    <div class="oee-value">${item.oee}%</div>
                    <div class="oee-formula">Disponibilité × Performance × Qualité</div>
                    <div class="oee-components">
                        <div class="oee-component">
                            <div class="oee-component-value" style="color: var(--success);">${item.disponibilite}%</div>
                            <div class="oee-component-label">Disponibilité</div>
                        </div>
                        <div class="oee-component">
                            <div class="oee-component-value" style="color: #38bdf8;">${item.performance}%</div>
                            <div class="oee-component-label">Performance</div>
                        </div>
                        <div class="oee-component">
                            <div class="oee-component-value" style="color: var(--warning);">${item.qualite}%</div>
                            <div class="oee-component-label">Qualité</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.85em;">
                        Production: ${item.production_reelle} / ${item.production_theorique} m³
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderPerformanceTable() {
            const table = document.getElementById('performanceTable');
            const headers = ['Équipement', 'OEE %', 'Disponibilité', 'Performance', 'Qualité', 'Temps Réel', 'Production'];
            
            table.innerHTML = `
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${dashboardData.oeeData.map(item => `
                    <tr>
                        <td style="font-weight: 600; color: #38bdf8;">${item.equipement}</td>
                        <td style="font-weight: 700; color: ${getStatusColorForValue(item.oee, 85, 70)};">${item.oee}%</td>
                        <td>${item.disponibilite}%</td>
                        <td>${item.performance}%</td>
                        <td>${item.qualite}%</td>
                        <td>${item.temps_reel}h</td>
                        <td>${item.production_reelle} m³</td>
                    </tr>
                `).join('')}</tbody>
            `;
        }

        // FONCTIONS UTILITAIRES
        function getStatusColor(status) {
            const colors = {
                'conforme': 'var(--success)',
                'attention': 'var(--warning)',
                'critique': 'var(--danger)',
                'nouveau': '#38bdf8',
                'positif': 'var(--success)',
                'negatif': 'var(--danger)',
                'available': 'var(--success)',
                'maintenance': 'var(--warning)',
                'broken': 'var(--danger)',
                'en_cours': '#38bdf8'
            };
            return colors[status] || '#38bdf8';
        }

        function getStatusFromText(text) {
            if (!text) return 'info';
            const lower = text.toLowerCase();
            if (lower.includes('en cours') || lower.includes('en_cours')) return 'en_cours';
            if (lower.includes('suivre') || lower.includes('alerte')) return 'warning';
            if (lower.includes('urgence') || lower.includes('critique')) return 'critique';
            return 'info';
        }

        function getStatusColorForValue(value, good, warning) {
            if (value >= good) return 'var(--success)';
            if (value >= warning) return 'var(--warning)';
            return 'var(--danger)';
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
        }

        // GESTION DES ALERTES ET POPUP
        function showAlert(message, type = 'info', duration = 5000) {
            const alert = document.getElementById(`alert${type.charAt(0).toUpperCase() + type.slice(1)}`);
            if (!alert) return;
            
            alert.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation' : 'info'}-circle"></i> ${message}`;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, duration);
        }

        function showPopup(title, content, status = 'info') {
            const modal = document.getElementById('popupModal');
            const popupTitle = document.getElementById('popupTitle');
            const popupBody = document.getElementById('popupBody');
            
            modal.classList.add('show');
            popupTitle.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${title}`;
            popupTitle.style.color = getStatusColor(status);
            popupBody.innerHTML = content;
            
            // Mettre à jour la couleur de la bordure
            document.querySelector('.popup-content').style.setProperty('--status-color', getStatusColor(status));
        }

        function closePopup() {
            document.getElementById('popupModal').classList.remove('show');
        }

        function popupAction() {
            showAlert('Action enregistrée. Redirection vers le système de ticketing...', 'success');
            closePopup();
        }

        // GESTION DATES
        function updateDateRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showAlert('Veuillez sélectionner une période valide', 'error');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                showAlert('La date de début doit être antérieure à la date de fin', 'error');
                return;
            }
            
            currentDateRange.start = new Date(startDate);
            currentDateRange.end = new Date(endDate);
            
            const display = document.getElementById('dateRangeDisplay');
            display.textContent = `${formatDateShort(startDate)} - ${formatDateShort(endDate)}`;
            
            document.getElementById('currentWeek').textContent = `${formatDateShort(startDate)}`;
            
            showAlert('Période mise à jour avec succès', 'success');
            loadTabData('kpi');
        }

        // FILTRES
        function filterTable() {
            const filter = document.getElementById('paramFilter').value.toLowerCase();
            const table = document.getElementById('paramTable');
            
            [...table.querySelectorAll('tbody tr')].forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        function resetFilter() {
            document.getElementById('paramFilter').value = '';
            filterTable();
        }

        function filterEquipement() {
            const filter = document.getElementById('equipementFilter').value.toLowerCase();
            const table = document.getElementById('suiviTable');
            
            [...table.querySelectorAll('tbody tr')].forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        }

        // STATS
        function updateStats() {
            document.getElementById('statKPI').textContent = dashboardData.kpi.length;
            document.getElementById('statSafety').textContent = dashboardData.securite.filter(i => i.ecart > 0).length;
            document.getElementById('statMaintenance').textContent = dashboardData.maintenance.length;
            document.getElementById('statInventory').textContent = dashboardData.inventaire.length;
        }

        // EXCEL IMPORT/EXPORT
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellText: false, cellDates: true });
                    
                    // Importer chaque feuille
                    const sheets = ['kpi', 'suivi', 'inventaire', 'securite', 'maintenance', 'planning', 'equipements'];
                    let imported = 0;
                    
                    sheets.forEach(sheetName => {
                        const ws = workbook.Sheets[sheetName];
                        if (ws) {
                            const cleanedData = cleanExcelData(ws);
                            if (cleanedData.length > 0) {
                                dashboardData[sheetName] = cleanedData;
                                imported++;
                            }
                        }
                    });
                    
                    // Gestion spéciale pour les données spéciales
                    if (workbook.Sheets['productionKPI']) {
                        dashboardData.productionKPI = cleanExcelData(workbook.Sheets['productionKPI']);
                    }
                    if (workbook.Sheets['oeeData']) {
                        dashboardData.oeeData = cleanExcelData(workbook.Sheets['oeeData']);
                    }
                    if (workbook.Sheets['equipmentAvailability']) {
                        dashboardData.equipmentAvailability = cleanExcelData(workbook.Sheets['equipmentAvailability']);
                    }
                    
                    loading.classList.remove('show');
                    showAlert(`${imported} feuilles importées avec succès`, 'success');
                    
                    // Recharger le tab actif
                    const activeTab = document.querySelector('.tab-content.active').id;
                    loadTabData(activeTab);
                    
                } catch (error) {
                    loading.classList.remove('show');
                    showAlert(`Erreur d'import: ${error.message}`, 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function downloadExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Ajouter chaque feuille
                wb.SheetNames.push('kpi');
                wb.Sheets['kpi'] = XLSX.utils.json_to_sheet(dashboardData.kpi);
                
                wb.SheetNames.push('suivi');
                wb.Sheets['suivi'] = XLSX.utils.json_to_sheet(dashboardData.suivi);
                
                wb.SheetNames.push('inventaire');
                wb.Sheets['inventaire'] = XLSX.utils.json_to_sheet(dashboardData.inventaire);
                
                wb.SheetNames.push('securite');
                wb.Sheets['securite'] = XLSX.utils.json_to_sheet(dashboardData.securite);
                
                wb.SheetNames.push('maintenance');
                wb.Sheets['maintenance'] = XLSX.utils.json_to_sheet(dashboardData.maintenance);
                
                wb.SheetNames.push('planning');
                wb.Sheets['planning'] = XLSX.utils.json_to_sheet(dashboardData.planning);
                
                wb.SheetNames.push('equipements');
                wb.Sheets['equipements'] = XLSX.utils.json_to_sheet(dashboardData.equipements);
                
                wb.SheetNames.push('productionKPI');
                wb.Sheets['productionKPI'] = XLSX.utils.json_to_sheet(dashboardData.productionKPI);
                
                wb.SheetNames.push('oeeData');
                wb.Sheets['oeeData'] = XLSX.utils.json_to_sheet(dashboardData.oeeData);
                
                wb.SheetNames.push('equipmentAvailability');
                wb.Sheets['equipmentAvailability'] = XLSX.utils.json_to_sheet(dashboardData.equipmentAvailability);
                
                // Générer le fichier
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `Dashboard_DesBaillets_${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                
                URL.revokeObjectURL(url);
                showAlert('Excel téléchargé avec succès', 'success');
                
            } catch (error) {
                showAlert(`Erreur d'export: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        }

        function downloadTemplate() {
            const templateData = {
                kpi: [
                    { domaine: "QUALITE", indicateur: "Turbidité", valeur: "", cible: "", statut: "conforme", responsable: "", frequence: "", pourcentage: 100 },
                    { domaine: "SECURITE", indicateur: "Accidents", valeur: "0", cible: "0", statut: "conforme", responsable: "", frequence: "", pourcentage: 100 }
                ],
                suivi: [
                    { param: "Paramètre 1", lundi: "", mardi: "", mercredi: "", jeudi: "", vendredi: "", commentaire: "" }
                ],
                inventaire: [
                    { produit: "Produit A", actuel: 0, seuil: 0, critique: 0, prochaine: "", commande: "", statut: "conforme" }
                ]
            };
            
            const wb = XLSX.utils.book_new();
            Object.keys(templateData).forEach(sheetName => {
                wb.SheetNames.push(sheetName);
                wb.Sheets[sheetName] = XLSX.utils.json_to_sheet(templateData[sheetName]);
            });
            
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Template_Dashboard_DesBaillets.xlsx';
            a.click();
            
            URL.revokeObjectURL(url);
            showAlert('Template téléchargé', 'info');
        }

        function resetAllData() {
            if (confirm('⚠️ Êtes-vous sûr de vouloir réinitialiser toutes les données? Cette action est irréversible.')) {
                initializeData();
                const activeTab = document.querySelector('.tab-content.active').id;
                loadTabData(activeTab);
                showAlert('Données réinitialisées avec succès', 'success');
            }
        }

        // TOOLTIP
        document.addEventListener('mousemove', function(e) {
            const tooltip = document.getElementById('tooltip');
            const hovered = document.querySelectorAll('[data-tooltip]:hover');
            
            if (hovered.length > 0) {
                const element = hovered[0];
                tooltip.textContent = element.getAttribute('data-tooltip');
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY + 10) + 'px';
            } else {
                tooltip.style.display = 'none';
            }
        });

        // INITIALISATION
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            loadTabData('kpi');
            
            // Fermer le popup en cliquant à l'extérieur
            document.getElementById('popupModal').addEventListener('click', function(e) {
                if (e.target === this) closePopup();
            });
            
            // Gestion des raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closePopup();
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    resetAllData();
                }
            });
            
            // Auto-refresh optionnel (toutes les 5 minutes)
            setInterval(() => {
                const activeTab = document.querySelector('.tab-content.active').id;
                loadTabData(activeTab);
            }, 300000);
        });
    </script>
</body>
</html>